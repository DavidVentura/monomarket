<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MonoMarket Client</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        h1 {
            color: #4ec9b0;
        }
        h2 {
            color: #569cd6;
            margin-top: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .connected {
            background: #1e3a1e;
            color: #4ec9b0;
        }
        .disconnected {
            background: #3a1e1e;
            color: #f48771;
        }
        .wallet-info {
            background: #2d2d30;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #3e3e42;
        }
        .wallet-info .label {
            color: #569cd6;
            font-weight: bold;
        }
        .wallet-info .value {
            color: #ce9178;
            word-break: break-all;
        }
        input, button {
            padding: 8px;
            margin: 5px;
            background: #2d2d30;
            color: #d4d4d4;
            border: 1px solid #3e3e42;
            border-radius: 4px;
        }
        input[type="number"] {
            width: 100px;
        }
        button {
            cursor: pointer;
        }
        button:hover {
            background: #3e3e42;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #console {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            padding: 10px;
            margin-top: 20px;
            height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #3e3e42;
        }
        .log-price { border-left-color: #4ec9b0; }
        .log-bought { border-left-color: #ce9178; }
        .log-sold { border-left-color: #dcdcaa; }
        .log-name { border-left-color: #c586c0; }
        .log-info { border-left-color: #569cd6; }
        .section {
            border: 1px solid #3e3e42;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>MonoMarket Client</h1>

    <div class="section">
        <h2>Wallet</h2>
        <div>
            <button onclick="generateWallet()">Generate New Wallet</button>
            <button onclick="loadWallet()">Load from Storage</button>
            <button onclick="clearWallet()">Clear Wallet</button>
        </div>
        <div id="walletInfo" class="wallet-info" style="display: none;">
            <div><span class="label">Address:</span> <span class="value" id="walletAddress"></span></div>
            <div><span class="label">Private Key:</span> <span class="value" id="walletPrivateKey"></span></div>
        </div>
    </div>

    <div class="section">
        <h2>WebSocket Connection</h2>
        <div id="status" class="status disconnected">Disconnected</div>
        <div>
            <input type="text" id="wsUrl" value="ws://localhost:8090" placeholder="WebSocket URL">
            <button onclick="connect()">Connect</button>
            <button onclick="disconnect()">Disconnect</button>
        </div>
    </div>

    <div class="section">
        <h2>Configuration</h2>
        <div>
            <input type="text" id="nameInput" placeholder="Your name">
            <button onclick="setName()">Set Name</button>
        </div>
    </div>

    <div class="section">
        <h2>Trading</h2>
        <div>
            <input type="number" id="buyAmount" placeholder="Amount" min="1" value="1">
            <button onclick="buy()" id="buyBtn">Buy</button>
        </div>
        <div>
            <input type="number" id="sellAmount" placeholder="Amount" min="1" value="1">
            <button onclick="sell()" id="sellBtn">Sell</button>
        </div>
    </div>

    <div class="section">
        <h2>Console</h2>
        <button onclick="clearConsole()">Clear Console</button>
        <div id="console"></div>
    </div>

    <script src="/ethers-5.7.2.umd.min.js"></script>
    <script>
        let ws = null;
        let wallet = null;
        let contract = null;
        let currentNonce = null;
        let contractAddress = null;
        let gasLimits = {
            register: null,
            buy: null,
            sell: null
        };

        const chainId = 30143;
        const gasPrice = ethers.BigNumber.from('0x21d664903c');

        const consoleEl = document.getElementById('console');
        const statusEl = document.getElementById('status');

        const CONTRACT_ABI = [
            "function register() external",
            "function buy(uint256 amount) external",
            "function sell(uint256 amount) external",
            "function getBalance(address user) external view returns (uint256)",
            "function getHoldings(address user) external view returns (uint256)",
            "function price() external view returns (uint256)"
        ];

        function log(message, type = 'info') {
            console.log(message);
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            consoleEl.appendChild(entry);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function updateStatus(connected) {
            if (connected) {
                statusEl.textContent = 'Connected';
                statusEl.className = 'status connected';
            } else {
                statusEl.textContent = 'Disconnected';
                statusEl.className = 'status disconnected';
            }
        }

        function generateWallet() {
            wallet = ethers.Wallet.createRandom();
            localStorage.setItem('wallet_privateKey', wallet.privateKey);
            displayWallet();
            log(`Generated new wallet: ${wallet.address}`, 'info');
        }

        function loadWallet() {
            const privateKey = localStorage.getItem('wallet_privateKey');
            if (!privateKey) {
                log('No wallet found in storage', 'info');
                return;
            }
            try {
                wallet = new ethers.Wallet(privateKey);
                displayWallet();
                log(`Loaded wallet: ${wallet.address}`, 'info');
            } catch (e) {
                log(`Failed to load wallet: ${e.message}`, 'info');
            }
        }

        function clearWallet() {
            localStorage.removeItem('wallet_privateKey');
            wallet = null;
            contract = null;
            document.getElementById('walletInfo').style.display = 'none';
            log('Wallet cleared', 'info');
        }

        function displayWallet() {
            document.getElementById('walletAddress').textContent = wallet.address;
            document.getElementById('walletPrivateKey').textContent = wallet.privateKey;
            document.getElementById('walletInfo').style.display = 'block';

            if (wallet && contractAddress && !contract) {
                contract = new ethers.Contract(contractAddress, CONTRACT_ABI, wallet);
                log(`Contract object created for address ${contractAddress}`, 'info');
            }
        }

        // updateProvider is no longer needed

        async function buy() {
            if (!wallet || !contract) {
                log('Please generate or load a wallet first', 'info');
                return;
            }

            if (currentNonce === null) {
                log('Nonce not loaded. Please wait or reconnect.', 'info');
                return;
            }

            if (!gasLimits.buy) {
                log('Gas limits not loaded. Please wait for connection info.', 'info');
                return;
            }

            const amount = document.getElementById('buyAmount').value;
            if (!amount || amount <= 0) {
                log('Please enter a valid amount', 'info');
                return;
            }

            try {
                log(`Preparing buy transaction for ${amount} shares...`, 'info');

                const tx = await contract.populateTransaction.buy(amount);

                tx.nonce = currentNonce;
                tx.chainId = chainId;
                tx.gasPrice = gasPrice;
                tx.gasLimit = gasLimits.buy;

                log(`TX fields: nonce=${tx.nonce}, chainId=${tx.chainId}, gasLimit=${tx.gasLimit}, gasPrice=${tx.gasPrice.toString()}`, 'info');

                const signedTx = await wallet.signTransaction(tx);

                if (ws && ws.readyState === WebSocket.OPEN) {
                    const message = {
                        type: 'raw_tx',
                        raw_tx: signedTx
                    };
                    ws.send(JSON.stringify(message));
                    currentNonce++; // Increment nonce for next transaction
                    log(`Buy transaction sent: ${amount} shares (next nonce: ${currentNonce})`, 'bought');
                } else {
                    log('WebSocket not connected', 'info');
                }
            } catch (e) {
                log(`Failed to create buy transaction: ${e.message}`, 'info');
            }
        }

        async function sell() {
            if (!wallet || !contract) {
                log('Please generate or load a wallet first', 'info');
                return;
            }

            if (currentNonce === null) {
                log('Nonce not loaded. Please wait or reconnect.', 'info');
                return;
            }

            if (!gasLimits.sell) {
                log('Gas limits not loaded. Please wait for connection info.', 'info');
                return;
            }

            const amount = document.getElementById('sellAmount').value;
            if (!amount || amount <= 0) {
                log('Please enter a valid amount', 'info');
                return;
            }

            try {
                log(`Preparing sell transaction for ${amount} shares...`, 'info');

                const tx = await contract.populateTransaction.sell(amount);

                tx.nonce = currentNonce;
                tx.chainId = chainId;
                tx.gasPrice = gasPrice;
                tx.gasLimit = gasLimits.sell;

                log(`TX fields: nonce=${tx.nonce}, chainId=${tx.chainId}, gasLimit=${tx.gasLimit}, gasPrice=${tx.gasPrice.toString()}`, 'info');

                const signedTx = await wallet.signTransaction(tx);

                if (ws && ws.readyState === WebSocket.OPEN) {
                    const message = {
                        type: 'raw_tx',
                        raw_tx: signedTx
                    };
                    ws.send(JSON.stringify(message));
                    currentNonce++; // Increment nonce for next transaction
                    log(`Sell transaction sent: ${amount} shares (next nonce: ${currentNonce})`, 'sold');
                } else {
                    log('WebSocket not connected', 'info');
                }
            } catch (e) {
                log(`Failed to create sell transaction: ${e.message}`, 'info');
            }
        }

        function connect() {
            const url = document.getElementById('wsUrl').value;
            log(`Connecting to ${url}...`, 'info');

            ws = new WebSocket(url);

            ws.onopen = () => {
                log('WebSocket connected!', 'info');
                updateStatus(true);

                if (wallet) {
                    setTimeout(() => {
                        getNonce();
                        const name = document.getElementById('nameInput').value;
                        if (name) {
                            setName();
                        }
                    }, 100);
                }
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                } catch (e) {
                    log(`Failed to parse message: ${event.data}`, 'info');
                }
            };

            ws.onerror = (error) => {
                log(`WebSocket error: ${error}`, 'info');
            };

            ws.onclose = () => {
                log('WebSocket disconnected', 'info');
                updateStatus(false);
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function handleMessage(data) {
            switch (data.type) {
                case 'connection_info':
                    contractAddress = data.contract_address;
                    gasLimits.register = data.gas_costs.register;
                    gasLimits.buy = data.gas_costs.buy;
                    gasLimits.sell = data.gas_costs.sell;
                    log(`ðŸ“¡ CONNECTION INFO: Contract ${contractAddress}`, 'info');
                    log(`â›½ Gas limits - register: ${gasLimits.register}, buy: ${gasLimits.buy}, sell: ${gasLimits.sell}`, 'info');

                    if (wallet && contractAddress) {
                        contract = new ethers.Contract(contractAddress, CONTRACT_ABI, wallet);
                        log(`Contract object created for address ${contractAddress}`, 'info');
                    }
                    break;

                case 'price_update':
                    log(`ðŸ“Š PRICE: ${data.old_price} â†’ ${data.new_price} (block ${data.block_number})`, 'price');
                    break;

                case 'bought':
                    const buyerName = data.name || 'Unknown';
                    log(`ðŸ’° BOUGHT: ${buyerName} (${data.user}) bought ${data.amount} @ ${data.price} | Balance: ${data.balance}, Holdings: ${data.holdings}`, 'bought');
                    break;

                case 'sold':
                    const sellerName = data.name || 'Unknown';
                    log(`ðŸ’¸ SOLD: ${sellerName} (${data.user}) sold ${data.amount} @ ${data.price} | Balance: ${data.balance}, Holdings: ${data.holdings}`, 'sold');
                    break;

                case 'name_set':
                    log(`ðŸ‘¤ NAME: ${data.address} â†’ ${data.name}`, 'name');
                    break;

                case 'position':
                    const posName = data.name || 'Unknown';
                    log(`ðŸ’¼ POSITION: ${posName} (${data.address}) | Cash: ${data.balance}, Holdings: ${data.holdings}, Price: ${data.current_price}`, 'info');
                    break;

                case 'tx_error':
                    log(`âŒ TX ERROR: ${data.error}`, 'info');
                    break;

                case 'nonce_response':
                    currentNonce = data.nonce;
                    log(`âœ… Nonce received: ${currentNonce}`, 'info');
                    break;

                default:
                    log(`Unknown message type: ${JSON.stringify(data)}`, 'info');
            }
        }

        async function getNonce() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('WebSocket not connected', 'info');
                return;
            }

            if (!wallet) {
                log('No wallet available', 'info');
                return;
            }

            const message = {
                type: 'get_nonce',
                address: wallet.address
            };

            ws.send(JSON.stringify(message));
            log(`Requesting nonce for ${wallet.address}...`, 'info');
        }

        async function setName() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('Not connected!', 'info');
                return;
            }

            if (!wallet || !contract) {
                log('Please generate or load a wallet first', 'info');
                return;
            }

            if (currentNonce === null) {
                log('Nonce not loaded. Please wait or reconnect.', 'info');
                return;
            }

            if (!gasLimits.register) {
                log('Gas limits not loaded. Please wait for connection info.', 'info');
                return;
            }

            const name = document.getElementById('nameInput').value;
            if (!name) {
                log('Please enter a name', 'info');
                return;
            }

            try {
                log(`Preparing register transaction...`, 'info');

                const tx = await contract.populateTransaction.register();

                tx.nonce = currentNonce;
                tx.chainId = chainId;
                tx.gasPrice = gasPrice;
                tx.gasLimit = gasLimits.register;

                log(`TX fields: nonce=${tx.nonce}, chainId=${tx.chainId}, gasLimit=${tx.gasLimit}, gasPrice=${tx.gasPrice.toString()}`, 'info');

                const signedTx = await wallet.signTransaction(tx);

                const rawTxMessage = {
                    type: 'raw_tx',
                    raw_tx: signedTx
                };
                ws.send(JSON.stringify(rawTxMessage));
                currentNonce++;
                log(`Register transaction sent (next nonce: ${currentNonce})`, 'info');

                const nameMessage = {
                    type: 'set_name',
                    name: name,
                    address: wallet.address
                };
                ws.send(JSON.stringify(nameMessage));
                log(`Name set to: ${name}`, 'name');
            } catch (e) {
                log(`Failed to create register transaction: ${e.message}`, 'info');
            }
        }

        function clearConsole() {
            consoleEl.innerHTML = '';
        }

        window.onload = () => {
            log('Page loaded. Generate or load a wallet to start.', 'info');
            loadWallet();
        };
    </script>
</body>
</html>
